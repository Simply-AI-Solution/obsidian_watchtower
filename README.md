# Obsidian Watchtower

[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Local-first corruption & funding-intelligence platform: immutable evidence vault + provenance-linked claim ledger, graph-native network tracing, time-machine diffs/alerts, and audit-ready case files (MD/PDF/JSON) generated by a multi-agent pipeline.

## Features

### Core Principles
- **No Claim Without Evidence**: Every claim must reference at least one piece of evidence
- **Append-Only Artifacts**: Immutable snapshots with SHA-256 hashes and timestamps
- **Provenance Tracking**: Complete tool and model version recording for reproducibility
- **Reproducible Fingerprints**: Every claim includes a reproducible run fingerprint

### Key Components

#### 1. Evidence Management
- Immutable evidence storage with SHA-256 hashing
- Automatic timestamp recording
- Tool and model version tracking
- Source attribution
- Cryptographic fingerprints for integrity verification

#### 2. Claims System
- Confidence scoring (0-1 range)
- Supporting and counter-evidence tracking
- Reproducible run fingerprints
- Metadata support
- Validation: No claim without evidence_ref

#### 3. Artifact Storage
- Append-only snapshots
- Version lineage tracking
- Multiple artifact types (evidence, claim, derived, report)
- SHA-256 content hashing
- Timestamp tracking

#### 4. Database Integration
- PostgreSQL + pgvector support for vector similarity search
- Graph database compatibility (Neo4j/Apache AGE)
- Indexed queries for performance
- Persistent storage

#### 5. Plugin System
- Modular source plugins for data extraction
- Plugin registry for management
- Sample manual entry plugin included
- Extensible architecture

#### 6. Export Functionality
- **Markdown**: Human-readable case files with claim IDs and evidence appendix
- **JSON**: Machine-readable structured data
- **PDF**: Audit-ready documents with full provenance

#### 7. Analysis Tools
- Run diff computation
- Artifact comparison
- Alert generation for significant changes
- Confidence change tracking

## Installation

```bash
# Clone the repository
git clone https://github.com/Simply-AI-Solution/obsidian_watchtower.git
cd obsidian_watchtower

# Install dependencies
pip install -r requirements.txt

# Or install with development dependencies
pip install -e ".[dev]"
```

## Quick Start

### Basic Usage

```python
from watchtower.storage import EvidenceStore, ClaimStore
from watchtower.export import MarkdownExporter, JSONExporter

# Initialize stores
evidence_store = EvidenceStore()
claim_store = ClaimStore(evidence_store)

# Store evidence
evidence = evidence_store.store_evidence(
    content="Bank statement showing suspicious transaction of $100,000",
    source="manual",
    metadata={"document_type": "bank_statement"},
    tool_name="watchtower",
    tool_version="0.1.0"
)

# Create a claim (requires evidence reference)
claim = claim_store.store_claim(
    statement="Company X received suspicious payment from offshore account",
    confidence=0.85,
    supporting_evidence_ids=[evidence.id],
    tool_name="watchtower",
    tool_version="0.1.0"
)

# Export case file
exporter = MarkdownExporter()
markdown_report = exporter.export_case(
    claims=[claim],
    evidence=[evidence],
    title="Investigation: Company X",
    metadata={"case_id": "2024-001", "investigator": "Jane Doe"}
)

print(markdown_report)
```

### Using Plugins

```python
from watchtower.plugins import PluginRegistry
from watchtower.plugins.manual_entry import ManualEntryPlugin

# Register plugin
registry = PluginRegistry()
plugin = ManualEntryPlugin()
registry.register(plugin)

# Extract evidence using plugin
config = {
    "content": "Document content here",
    "metadata": {"source_file": "document.pdf"}
}
evidence_list = plugin.extract(config)
```

### Generating Alerts

```python
from watchtower.utils import AlertGenerator

# Create alert generator
alert_gen = AlertGenerator(
    confidence_drop_threshold=0.2,
    confidence_high_threshold=0.9
)

# Generate alerts from claims
alerts = alert_gen.generate_alerts(
    claims=current_claims,
    previous_claims=previous_claims
)

# Get summary
summary = alert_gen.generate_summary(alerts)
print(f"Total alerts: {summary['total_alerts']}")
```

### Computing Run Diffs

```python
from watchtower.utils import compute_run_diff

# Compare two sets of claims
diff = compute_run_diff(claims_from_run_1, claims_from_run_2)

print(f"Added: {len(diff['added_claims'])}")
print(f"Removed: {len(diff['removed_claims'])}")
print(f"Modified: {len(diff['modified_claims'])}")
```

## Architecture

### Data Models

#### Evidence
```python
Evidence(
    content: str,              # Raw evidence content
    source: str,               # Source identifier
    metadata: Dict[str, Any],  # Additional metadata
    tool_name: str,            # Tool that created evidence
    tool_version: str,         # Tool version
    model_name: str,           # AI model name (optional)
    model_version: str,        # AI model version (optional)
    timestamp: datetime,       # Creation timestamp
    sha256: str,               # SHA-256 hash (computed)
    fingerprint: str           # Reproducible fingerprint (computed)
)
```

#### Claim
```python
Claim(
    statement: str,                       # The claim being made
    confidence: float,                    # 0-1 confidence score
    supporting_evidence_ids: List[str],   # Supporting evidence IDs
    counter_evidence_ids: List[str],      # Counter evidence IDs
    metadata: Dict[str, Any],             # Additional metadata
    tool_name: str,                       # Tool that created claim
    tool_version: str,                    # Tool version
    model_name: str,                      # AI model name (optional)
    model_version: str,                   # AI model version (optional)
    timestamp: datetime,                  # Creation timestamp
    run_fingerprint: str                  # Reproducible fingerprint (computed)
)
```

#### Artifact
```python
Artifact(
    artifact_type: str,        # Type: evidence, claim, derived, report
    content: str,              # Artifact content (JSON-serialized)
    parent_artifact_id: str,   # Parent for versioning (optional)
    metadata: Dict[str, Any],  # Additional metadata
    tool_name: str,            # Tool that created artifact
    tool_version: str,         # Tool version
    timestamp: datetime,       # Creation timestamp
    sha256: str,               # SHA-256 hash (computed)
    fingerprint: str           # Reproducible fingerprint (computed)
)
```

## Development

### Running Tests

```bash
# Install development dependencies
pip install -e ".[dev]"

# Run all tests
pytest

# Run with coverage
pytest --cov=watchtower --cov-report=html

# Run specific test file
pytest tests/unit/test_evidence.py

# Run with verbose output
pytest -v
```

### Code Quality

```bash
# Format code with black
black watchtower tests

# Lint with ruff
ruff watchtower tests

# Type checking with mypy
mypy watchtower
```

## Database Setup

### PostgreSQL + pgvector

```sql
-- Create database
CREATE DATABASE watchtower;

-- Connect to database
\c watchtower

-- Enable pgvector extension
CREATE EXTENSION vector;
```

### Using PostgresStore

```python
from watchtower.database import PostgresStore

# Initialize store
store = PostgresStore("postgresql://user:pass@localhost/watchtower")
store.connect()
store.init_schema()

# Store evidence
store.store_evidence(evidence)

# Store claim
store.store_claim(claim)

# Disconnect
store.disconnect()
```

## Contributing

Contributions are welcome! Please ensure:

1. All tests pass: `pytest`
2. Code is formatted: `black watchtower tests`
3. Type hints are present: `mypy watchtower`
4. New features include tests
5. Documentation is updated

## License

MIT License - see [LICENSE](LICENSE) file for details

## Project Structure

```
obsidian_watchtower/
├── watchtower/
│   ├── __init__.py
│   ├── models/              # Core data models
│   │   ├── evidence.py      # Evidence model
│   │   ├── claim.py         # Claim model
│   │   └── artifact.py      # Artifact model
│   ├── storage/             # Storage implementations
│   │   ├── evidence_store.py
│   │   ├── claim_store.py
│   │   └── artifact_store.py
│   ├── database/            # Database integration
│   │   └── postgres_store.py
│   ├── plugins/             # Plugin system
│   │   ├── base.py          # Base plugin interface
│   │   ├── registry.py      # Plugin registry
│   │   └── manual_entry.py  # Sample plugin
│   ├── export/              # Export functionality
│   │   ├── markdown_exporter.py
│   │   ├── json_exporter.py
│   │   └── pdf_exporter.py
│   └── utils/               # Utility functions
│       ├── diff.py          # Diff computation
│       └── alerts.py        # Alert generation
├── tests/
│   ├── unit/                # Unit tests
│   └── integration/         # Integration tests
├── pyproject.toml           # Project configuration
├── requirements.txt         # Dependencies
└── README.md               # This file
```

## Roadmap

- [ ] Neo4j/Apache AGE graph database integration
- [ ] Advanced vector similarity search
- [ ] Web UI for investigation management
- [ ] Additional source plugins (API, web scraping, etc.)
- [ ] Multi-agent pipeline orchestration
- [ ] Enhanced visualization tools
- [ ] Real-time monitoring and alerting

## Citation

If you use Obsidian Watchtower in your research or investigation work, please cite:

```bibtex
@software{obsidian_watchtower,
  title = {Obsidian Watchtower: Local-first Fraud Investigation System},
  author = {Simply AI Solution},
  year = {2026},
  url = {https://github.com/Simply-AI-Solution/obsidian_watchtower}
}
```
